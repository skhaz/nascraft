#!/usr/bin/env bash

# shellcheck source=/dev/null
. jails/base

set -x

if [[ ! -f "$ABS_DIR"/secret.json ]]; then
	echo "you must provide the file 'secret.json' generated by google cloud console."
	echo "more details on 'install and configure' page: https://git.io/JelII"
	exit 0
fi

JAIL_IP=192.168.1.30 && \
	export JAIL_IP

zfs create -o recordsize=128K tank/apps/"$JAIL_NAME"

cat <<EOF >/tmp/pkglist.json
{
	"pkgs": [
		"python36",
		"py36-sqlite3",
		"py36-pycryptodome",
		"py36-openssl"
	]
}
EOF

iocage create -r "$RELEASE" -n "$JAIL_NAME" -p /tmp/pkglist.json \
	vnet="$VNET" \
	boot="$BOOT" \
	defaultrouter="$ROUTER" \
	ip4_addr="$INTERFACE|$JAIL_IP/24"

rm -f /tmp/pkglist.json

iocage exec "$JAIL_NAME" env ASSUME_ALWAYS_YES=YES \
	python3.6 -Im ensurepip --upgrade --default-pip
iocage exec "$JAIL_NAME" pip install gphotos-sync
iocage exec "$JAIL_NAME" "pw groupadd -g $(getent group wheel | cut -d: -f3) -n wheel"
iocage exec "$JAIL_NAME" "pw user add backup -c backup -d /nonexistent -s /usr/bin/nologin"
iocage exec "$JAIL_NAME" "pw groupmod wheel -m backup"

LIBRARY_DIR=/mnt/tank/backup/library/photos && \
	export LIBRARY_DIR

LOCAL_LIBRARY=$(echo "$LIBRARY_DIR" | sed 's/tank\///')

zfs create -o recordsize=1M -o compression=off -p "$(echo $LIBRARY_DIR | sed 's/\/mnt\///')"

iocage exec "$JAIL_NAME" "mkdir -p /settings $LOCAL_LIBRARY"
iocage exec "$JAIL_NAME" "chgrp -R wheel $LOCAL_LIBRARY"
iocage fstab -a "$JAIL_NAME" "$SETTINGS_PATH /settings nullfs rw 0 0"
iocage fstab -a "$JAIL_NAME" "$LIBRARY_DIR $LOCAL_LIBRARY nullfs rw 0 0"

cp "$ABS_DIR/secret.json" "$SETTINGS_PATH/secret.json"

cat <<-EOF >"$SETTINGS_PATH/sync"
	#!/bin/sh

	LANG=en_US.UTF-8 \
		/usr/local/bin/gphotos-sync \
			--retry-download \
			--db-path /settings \
			--secret /settings/secret.json \
			/mnt/backup/library/photos/google
EOF

iocage exec "$JAIL_NAME" "chmod +x /settings/sync"
iocage exec "$JAIL_NAME" "chmod go-rwx /settings/sync"
iocage exec "$JAIL_NAME" "(crontab -l ; echo '@daily /settings/sync') | sort - | uniq - | crontab -"